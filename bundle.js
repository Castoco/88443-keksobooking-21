(()=>{"use strict";(()=>{const e="any",t=document.querySelector(".map__filters"),o=t.querySelector("#housing-type"),r=t.querySelector("#housing-price"),n=t.querySelector("#housing-rooms"),a=t.querySelector("#housing-guests");let i=[];const s=()=>{let e={features:[],typePin:"any",price:"any",rooms:"any",guests:"any"};e.typePin=o.value,e.price=r.value,e.rooms=n.value,e.guests=a.value,e.features=Array.from(document.querySelectorAll(".map__checkbox:checked"));let t=[];for(let o=0;o<i.length&&t.length<window.data.PINS_COUNT;o++)d(i[o],e)&&t.push(i[o]);window.data.renderPins(t)};t.addEventListener("change",(()=>{window.util.debounce(s),window.main.closePopup()}));const d=(t,o)=>{let r=!0,n=!0,a=!0,i=!0,s=!0;return o.typePin!==e&&(r=t.offer.type===o.typePin),o.price!==e&&(n=c(t.offer.price)===o.price),o.rooms!==e&&(a=l(t.offer.rooms)===o.rooms),o.guests!==e&&(i=u(t.offer.guests)===o.guests),o.features.length>0&&(s=((e,t)=>{let o=!0;return t.forEach((t=>{e.includes(t.value)||(o=!1)})),o})(t.offer.features,o.features)),r&&n&&a&&i&&s},c=t=>{let o=e;return(t>=1e4||t<=5e4)&&(o="middle"),t<1e4&&(o="low"),t>5e4&&(o="high"),o},l=t=>{let o=String(t);return(t>3||t<=0)&&(o=e),o},u=t=>{let o=String(t);return(t>2||t<0)&&(o=e),o};window.filterMap={successHandler:e=>{i=e,s()},mapFilters:t}})(),(()=>{const e=Math.round(32.5),t=document.querySelector(".ad-form"),o=t.querySelector("#address"),r=document.querySelector(".map"),n=r.querySelector(".map__pin--main"),a=()=>{n.addEventListener("mousedown",(t=>{t.preventDefault();let o={x:t.clientX,y:t.clientY};const r=t=>{t.preventDefault(),s();const r=o.x-t.clientX,a=o.y-t.clientY;o={x:t.clientX,y:t.clientY},n.offsetLeft-r+e>=0&&n.offsetLeft-r+e<=window.data.MAP_WIDTH&&(n.style.left=n.offsetLeft-r+"px"),n.offsetTop-a+65+15>=window.data.MAP_TOP_Y&&n.offsetTop-a+65+15<=window.data.MAP_BOTTOM_Y&&(n.style.top=n.offsetTop-a+"px")},a=e=>{e.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",a)}))};a();const i={x:n.offsetLeft+e,y:n.offsetTop+Math.round(32.5)},s=t=>(t||(t={x:n.offsetLeft+e,y:n.offsetTop+65+15}),o.setAttribute("value",`${t.x}, ${t.y}`),o.setAttribute("readonly","readonly"),t);window.moving={mainPinCenter:i,movingPin:a,getMainPinAdress:s,adForm:t,map:r}})(),(()=>{const e=window.moving.map,t=e.querySelector(".map__filters").querySelectorAll("select"),o=e.querySelector(".map__features").querySelectorAll("input"),r=window.moving.adForm,n=r.querySelectorAll("select"),a=r.querySelectorAll("input"),i=r.querySelector("textarea"),s=r.querySelectorAll("button"),d=e.querySelector(".map__pin--main"),c=()=>{const e=Array.from(n),r=Array.from(a).concat(e);r.push(i);const d=Array.from(s),c=r.concat(d),l=Array.from(t),u=Array.from(o),m=l.concat(u);return c.concat(m)},l=c(),u=()=>{e.classList.add("map--faded"),r.classList.add("ad-form--disabled"),l.forEach((e=>{e.setAttribute("disabled","disabled"),e.style.boxShadow=""})),e.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()})),d.style.top="375px",d.style.left="570px",window.moving.getMainPinAdress(window.moving.mainPinCenter)};u();const m=e=>{1===e.which&&(w(),window.form.activate()),d.removeEventListener("mousedown",m)},p=e=>{"Enter"===e.key&&(w(),window.form.activate(),d.removeEventListener("keydown",p))};d.addEventListener("mousedown",m),d.addEventListener("keydown",p);const w=()=>{window.moving.getMainPinAdress(),window.dataServer.load("https://21.javascript.pages.academy/keksobooking/data","GET",window.filterMap.successHandler,window.util.renderErrorMesage),window.form.buttonReset.addEventListener("click",window.form.reset)};r.addEventListener("submit",(e=>{e.preventDefault(),window.dataServer.load("https://21.javascript.pages.academy/keksobooking","POST",window.form.getSucces,window.form.getError,new FormData(r))}));const y=()=>{const t=e.querySelector(".popup");t&&t.remove(),document.removeEventListener("keydown",f);const o=e.querySelector(".map__pin--active");o&&o.classList.remove("map__pin--active")},f=e=>{window.util.onModalPressEsc(e,y)};window.main={onClickPin:(t,o)=>{t.addEventListener("click",(()=>{const r=e.querySelector(".map__pin--active");e.querySelector(".popup")&&y(),r&&r.classList.remove("map__pin--active"),window.card.makeOffer(o),t.classList.add("map__pin--active")}))},map:e,closePopup:y,adForm:r,inputs:l,disabledPage:u,mainPin:d,onPinMouseDown:m,getInputs:c,onCardPessEsc:f}})(),window.dataServer={load:(e,t,o,r,n)=>{const a=new XMLHttpRequest;a.responseType="json",a.addEventListener("load",(()=>{let e;switch(a.status){case 200:o(a.response);break;case 400:e=`Неверный запрос ${a.status} + ${a.statusText}`;break;case 401:e="Пользователь не авторизован";break;case 404:e="Ничего не найдено";break;default:e=`${a.status}  + ${a.statusText}`}e&&r(e)})),a.addEventListener("error",(()=>{r("Произошла ошибка соединения")})),a.open(t,e),a.send(n)}},(()=>{let e=null;window.util={renderErrorMesage:e=>{const t=document.createElement("div");t.textContent=e,t.style="width: 100%; height: 100px; margin: 0 auto; background: red; text-align: center; top: 300px",t.style.position="absolute",t.style.fontSize="30px",window.main.map.append(t)},debounce:t=>{e&&window.clearTimeout(e),e=window.setTimeout(t,500)},onModalPressEsc:(e,t)=>{"Escape"===e.key&&t()}}})(),(()=>{const e=window.main.map.querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin"),o=e=>{const o=t.cloneNode(!0);return o.style=`left: ${e.location.x-25}px; top: ${e.location.y-70}px;`,o.querySelector("img").src=e.author.avatar,o.querySelector("img").alt=e.offer.title,o};window.data={TYPE_HOTEL:{palace:{name:"Дворец",minprice:1e4},flat:{name:"Квартира",minprice:1e3},house:{name:"Дом",minprice:5e3},bungalow:{name:"Бунгало",minprice:0}},renderElement:o,MAP_WIDTH:1200,MAP_TOP_Y:130,MAP_BOTTOM_Y:630,renderPins:t=>{const r=e.querySelectorAll(".map__pin:not(.map__pin--main)"),n=document.createDocumentFragment();r.forEach((e=>{e.remove()})),t.forEach((t=>{let r=o(t);window.main.onClickPin(r,t),n.appendChild(r),e.appendChild(n)}))},PINS_COUNT:5}})(),(()=>{const e=window.main.map.querySelector(".map__filters-container"),t=document.createDocumentFragment(),o=document.querySelector("#card").content.querySelector(".map__card");window.card={makeOffer:r=>{const n=(e=>{const t=o.cloneNode(!0);t.querySelector(".popup__avatar").src=e.author.avatar,t.querySelector(".popup__title").textContent=e.offer.title,t.querySelector(".popup__text--address").textContent=e.offer.address,t.querySelector(".popup__text--price").textContent=`${e.offer.price} ₽/ночь`,t.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} комнаты для ${e.offer.guests}`,t.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`,t.querySelector(".popup__type").textContent=window.data.TYPE_HOTEL[e.offer.type].name;const r=t.querySelector(".popup__features");r.innerHTML="",e.offer.features.length||t.removeChild(r),e.offer.features.forEach((e=>{const t=document.createElement("li");t.classList.add("popup__feature",`popup__feature--${e}`),r.appendChild(t)})),t.querySelector(".popup__description").textContent=e.offer.description;const n=t.querySelector(".popup__photos"),a=n.querySelector(".popup__photo");return e.offer.photos.length||t.removeChild(n),e.offer.photos.forEach((e=>{const t=a.cloneNode(!0);t.src=e,n.appendChild(t)})),n.removeChild(a),t})(r),a=n.querySelector(".popup__close");window.main.map.insertBefore(t.appendChild(n),e),a.addEventListener("click",window.main.closePopup),document.addEventListener("keydown",window.main.onCardPessEsc)}}})(),(()=>{const e="0 0 2px 2px #ff0000",t=window.main.adForm.querySelector("#room_number"),o=window.main.adForm.querySelector("#capacity"),r=window.main.adForm.querySelector("#price"),n=window.main.adForm.querySelector("#type"),a=window.main.adForm.querySelector("#timein"),i=window.main.adForm.querySelector("#timeout"),s=document.querySelector("#success").content.querySelector(".success"),d=document.querySelector("#error").content.querySelector(".error"),c=document.querySelector("main"),l=document.querySelector(".ad-form__reset"),u=s=>{if(s.target.setCustomValidity(""),s.target.style.boxShadow="",(s.target.matches("#capacity")||s.target.matches("#room_number"))&&(t.setCustomValidity(""),t.style.boxShadow="",o.setCustomValidity(""),o.style.boxShadow="",(100!==parseInt(t.value,10)&&0===parseInt(o.value,10)||100===parseInt(t.value,10)&&0!==parseInt(o.value,10))&&(s.target.setCustomValidity(`Выберете другое количество гостей для ${t.value} комнат`),s.target.style.boxShadow=e),parseInt(o.value,10)>parseInt(t.value,10)&&(s.target.setCustomValidity(`Много гостей для ${t.value}  комнаты`),s.target.style.boxShadow=e)),s.target.matches("#title")){const t=s.target.value.length;s.target.setCustomValidity(""),t<30&&(s.target.setCustomValidity(`Минимум 30 символов, введите еще ${30-t} симв`),s.target.style.boxShadow=e),t>100&&(s.target.setCustomValidity(`Максимум 100 символов, удалите еще  ${t-100} симв`),s.target.style.boxShadow=e)}s.target.matches("#type")&&(r.setAttribute("placeholder",`${window.data.TYPE_HOTEL[s.target.value].minprice}`),r.setAttribute("min",`${window.data.TYPE_HOTEL[s.target.value].minprice}`)),(s.target.matches("#price")||s.target.matches("#type"))&&(r.setCustomValidity(""),n.setCustomValidity(""),r.style.boxShadow="",n.style.boxShadow="",r.value<window.data.TYPE_HOTEL[n.value].minprice&&(s.target.setCustomValidity(`Минимальная цена, для данного типа жилья ${window.data.TYPE_HOTEL[n.value].minprice} руб`),s.target.style.boxShadow=e)),s.target.matches("#timein")&&(i.value=a.value),s.target.matches("#timeout")&&(a.value=i.value),s.target.reportValidity()};window.main.adForm.addEventListener("input",u);const m=e=>{const t=document.createDocumentFragment();t.appendChild(e),c.appendChild(t),document.addEventListener("keydown",window.onModalPressEsc),e.addEventListener("click",(t=>{t.preventDefault(),e.remove()}))};window.util.onModalPressEsc((()=>{const e=document.querySelector(".success"),t=document.querySelector(".error");e?e.remove():d&&t.remove(),document.removeEventListener("keydown",window.onModalPressEsc)}));const p=()=>{window.main.disabledPage(),window.main.closePopup(),window.main.mainPin.addEventListener("mousedown",window.main.onPinMouseDown),window.main.mainPin.addEventListener("keydown",window.main.onPinKeyDown)},w=()=>{window.main.adForm.reset(),window.filterMap.mapFilters.reset(),p(),r.setAttribute("placeholder",`${window.data.TYPE_HOTEL.house.minprice}`)};window.form={activate:()=>{window.main.map.classList.remove("map--faded"),window.main.adForm.classList.remove("ad-form--disabled"),window.main.inputs.forEach((e=>{e.removeAttribute("disabled","disabled")}))},adPrice:r,mainpage:c,getSucces:()=>{const e=s.cloneNode(!0);m(e),window.main.adForm.reset(),w()},getError:()=>{const e=d.cloneNode(!0);m(e)},buttonReset:l,reloadPage:p,reset:w,makeAd:u,INPUT_SHADOW:e}})(),(()=>{const e=["image/jpg","image/jpeg","image/png","image/gif","image/png"],t=window.moving.adForm,o=t.querySelector(".ad-form__field input[type=file]"),r=t.querySelector(".ad-form__upload input[type=file]"),n=t.querySelector(".ad-form__photo"),a=t.querySelector(".ad-form-header__preview img");o.addEventListener("change",(()=>{s(o,a)})),r.addEventListener("change",(()=>{i()}));const i=()=>{const e=document.createElement("img");e.style="width: 40px; height: 44px; margin: 0 auto",e.alt="Фото жилья",e.src=" ",n.appendChild(e),n.style="display: flex; align-items: center;";const o=t.querySelector(".ad-form__photo img");s(r,o)},s=(t,o)=>{const r=t.files[0],n=r.type;if(e.some((function(e){return n===e}))){const e=new FileReader;e.addEventListener("load",(function(){o.src=e.result})),e.readAsDataURL(r)}}})()})();